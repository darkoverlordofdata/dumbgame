#include "game.h"
#include "corefw/object.h"
#include "corefw/random.h"
#include "pet.h"
#include "splash.h"
#include "wasm4.h"

static struct __CFClass class = {
      .name = "Game",
      .size = sizeof(struct __Game),
};
CFClassRef Game = &class;
// food
#define foodWidth 30
#define foodHeight 26
#define foodFlags BLIT_2BPP
const uint8_t food[195] = { 0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x05,0x00,0x05,0x50,0x00,0x00,0x14,0x55,0xa4,0x01,0xaa,0x00,0x00,0x02,0x9a,0xaa,0x40,0x2a,0xa0,0x00,0x00,0x2a,0xaa,0xa4,0x02,0xaa,0x80,0x00,0x00,0xaa,0x9a,0x40,0x2a,0xa8,0x00,0x00,0x0a,0xaa,0xa9,0x02,0xaa,0x80,0x00,0x00,0xaa,0xaa,0x40,0xaa,0xa8,0x00,0x00,0x0a,0xaa,0xa4,0x1a,0xaa,0x80,0x00,0x00,0xaa,0xaa,0x41,0xaa,0xa8,0x00,0x00,0x0a,0xaa,0xa4,0x1a,0xaa,0x80,0x00,0x00,0x2a,0xa8,0x01,0xaa,0xa8,0x00,0x00,0x00,0x6a,0x80,0x1a,0xaa,0x80,0x00,0x00,0x01,0xa8,0x01,0xaa,0xa8,0x00,0x00,0x00,0x1a,0x80,0x1a,0xaa,0x80,0x00,0x00,0x01,0xa8,0x01,0xaa,0xa8,0x00,0x00,0x00,0x5a,0x80,0x0a,0xaa,0x80,0x00,0x00,0x06,0xa8,0x00,0x01,0xa8,0x00,0x00,0x00,0x6a,0x90,0x00,0x1a,0x80,0x00,0x00,0x1a,0xaa,0x40,0x01,0xa8,0x00,0x00,0x02,0xaa,0xa4,0x00,0x6a,0x80,0x00,0x00,0x2a,0xaa,0x40,0x0a,0xa9,0x00,0x00,0x01,0xaa,0x90,0x00,0xaa,0x90,0x00,0x00,0x06,0xa8,0x00,0x0a,0xa4,0x00,0x00,0x00,0x1a,0x00,0x00,0xa9,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 };

extern unsigned long frameCounter;

const int RgbPink = 0xfea8a8;       // #fea8a8 apricot haze
const int RgbYellow = 0xa8fea8;     // #a8fea8 creamy mint
const int RgbBlue = 0xa8a8fe;       // #a8a8fe widowmaker
const int RgbBlack = 0x14080a;      // #14080a asphalt

// wormy
GameRef method Ctor(GameRef this) {
    (void *)this;
    this->first = true;
    this->state = GameStateSplashScreen;
    this->frameCounter = 0;
    this->splash = NewSplash();
    return this;
}

void method Start(GameRef this) {
    (void *)this;

    //https://lospec.com/palette-list/ice-cream-gb
    PALETTE[0] = 0xfff6d3;
    PALETTE[1] = 0xf9a875;
    PALETTE[2] = 0xeb6b6f;
    PALETTE[3] = 0x7c3f58;  

    this->pet = NewPet("frodo");
    Move(this->pet, 80, 25);
}

void method Update(GameRef this) {
    (void *)this;
    this->frameCounter++;

    switch (this->state) {
    case GameStateSplashScreen:
        Update(this->splash);
        uint8_t gamepad = *GAMEPAD1;
        uint8_t pressedThisFrame = gamepad & (gamepad ^ this->previousGamepad);
        if (pressedThisFrame & BUTTON_1) {
            if (this->first) {
                tracef("%d", (int)this->frameCounter);
                this->rnd = NewRandom(frameCounter);
                this->first = false;
            }
            this->previousGamepad = gamepad;
            trace("X button was just pressed!");
        }
        break;

    case GameStateRunning:

        break;

    case GameStateEnd:

        break;
    }
}

void method Draw(GameRef this) {
    (void *)this;
    switch (this->state) {
    case GameStateSplashScreen:
        *DRAW_COLORS = 0x0321;
        Draw(this->splash);
        blit(food, 40, 40, foodWidth, foodHeight, foodFlags);

        *DRAW_COLORS = 4;
        text("X - Play", 80, 70);
        text("Y - Opts", 80, 85);

        break;

    case GameStateRunning:

        break;

    case GameStateEnd:

        break;
    }
}
